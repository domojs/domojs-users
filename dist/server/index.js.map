{"version":3,"sources":["index.ts"],"names":[],"mappings":";AAAA,iCAAmC;AAEnC,mCAAqC;AAIrC,IAAI,mBAAmB,GAAG,OAAO,CAAC,sBAAsB,CAAC,CAAC,QAAQ,CAAC;AACnE,IAAI,WAAW,GAAG,OAAO,CAAC,qBAAqB,CAAC,CAAC,QAAQ,CAAC;AAC1D,IAAI,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,CAAC,cAAc,CAAC,CAAC;AAE7C,EAAE,CAAC,cAAc,CAAC,CAAC,MAAM,EAAE,SAAS,CAAC,EAAE,UAAU,IAAI,EAAE,OAAO;IAE1D,OAAO,CAAC,MAAM,CAAC,QAAQ,EAAE,UAAU,EAAE,IAAI,CAAC,CAAC;IAC3C,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE;QAEb,EAAE,CAAC,cAAc,CAAC,CAAC,SAAS,EAAE,SAAS,EAAE,MAAM,CAAC,EAAE,UAAU,MAAM,EAAE,GAAmB,EAAE,GAAG;YAExF,GAAG,CAAC,GAAG,CAAC,UAAU,GAAG,EAAE,GAAG,EAAE,IAAI;gBAE5B,GAAG,CAAC,iBAAiB,CAAC,GAAG;oBAErB,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;gBACzB,CAAC,CAAA;gBACD,IAAI,EAAE,CAAC;YACX,CAAC,CAAC,CAAA;YACF,GAAG,CAAC,GAAG,CAAC,YAAY,EAAE,QAAQ,CAAC,YAAY,CAAC,aAAa,EAAE,EAAE,eAAe,EAAE,QAAQ,EAAE,eAAe,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC;YACjH,GAAG,CAAC,GAAG,CAAC,gBAAgB,EAAE,QAAQ,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,eAAe,EAAE,QAAQ,EAAE,eAAe,EAAE,GAAG,EAAE,CAAC,CAAC,CAAC;YAG7G,GAAG,CAAC,GAAG,CAAC,WAAW,EAAE,UAAU,GAAoB,EAAE,GAAqB,EAAE,IAA0B;gBAElG,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAC9B,CAAC;oBACG,GAAG,CAAC,UAAU,GAAG,GAAG,CAAC;oBACrB,GAAG,CAAC,GAAG,EAAE,CAAC;gBACd,CAAC;gBACD,IAAI;oBACA,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;YAC9B,CAAC,CAAC,CAAC;YAEH,GAAG,CAAC,GAAG,CAAC,SAAS,EAAE,EAAE,CAAC,OAAO,CAAC,CAAC,UAAU,EAAE,WAAW,CAAC,EAAE,UAAU,QAAyB,EAAE,SAAS;gBAEnG,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,iBAAiB,CAAC,EAAE,CAAC;oBAC/B,SAAS,CAAC,GAAG,CAAC,CAAC;gBACnB,IAAI;oBACA,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;YACpC,CAAC,CAAC,CAAC,CAAC;QACR,CAAC,CAAC,EAAE,CAAC;IACT,CAAC,CAAC,CAAA;AACN,CAAC,CAAC,EAAE,CAAC","file":"index.js","sourcesContent":["import * as di from 'akala-corere';\r\nimport * as express from 'express';\r\nimport * as passport from 'passport';\r\nimport * as db from '../../../db';\r\nimport { resolve, dirname } from 'path';\r\n\r\nvar WindowsLiveStrategy = require('passport-windowslive').Strategy;\r\nvar MacStrategy = require('passport-macaddress').Strategy;\r\nvar debug = require('debug')('domojs:users');\r\n\r\ndi.injectWithName(['$bus', '$master'], function ($bus, $master)\r\n{\r\n    $master(module.filename, './master', null);\r\n    $bus.on('ready', function ()\r\n    {\r\n        di.injectWithName(['$config', '$router', '$bus'], function (config, app: express.Router, bus)\r\n        {\r\n            app.use(function (req, res, next)\r\n            {\r\n                req['isAuthenticated'] = function ()\r\n                {\r\n                    return !!req['user'];\r\n                }\r\n                next();\r\n            })\r\n            app.get('/api/login', passport.authenticate('windowslive', { failureRedirect: '/error', successRedirect: '/' }));\r\n            app.get('/api/login-mac', passport.authenticate('mac', { failureRedirect: '/error', successRedirect: '/' }));\r\n\r\n\r\n            app.get('/api/user', function (req: Express.Request, res: express.Response, next: express.NextFunction)\r\n            {\r\n                if (!req['isAuthenticated']())\r\n                {\r\n                    res.statusCode = 404;\r\n                    res.end();\r\n                }\r\n                else\r\n                    res.send(req['user']);\r\n            });\r\n\r\n            app.get('/api/me', di.command(['$request', '$callback'], function ($request: express.Request, $callback)\r\n            {\r\n                if (!$request['isAuthenticated']())\r\n                    $callback(404);\r\n                else\r\n                    $callback($request['user']);\r\n            }));\r\n        })();\r\n    })\r\n})();"],"sourceRoot":"users/src/server"}