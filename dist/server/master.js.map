{"version":3,"sources":["master.ts"],"names":[],"mappings":"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","file":"master.js","sourcesContent":["import * as di from 'akala-core';\r\nimport * as express from 'express';\r\nimport * as passport from 'passport';\r\nimport * as db from '../../../db';\r\nvar WindowsLiveStrategy = require('passport-windowslive').Strategy;\r\nvar MacStrategy = require('passport-macaddress').Strategy;\r\nvar debug = require('debug')('domojs:users');\r\n\r\n\r\npassport.serializeUser(function (user, done)\r\n{\r\n    done(null, user);\r\n});\r\n\r\npassport.deserializeUser(function (user, done)\r\n{\r\n    done(null, user);\r\n});\r\n\r\ndi.injectWithName(['$config', '$router'], function (config, app: express.Router)\r\n{\r\n    if (config && config.microsoft)\r\n    {\r\n        passport.use(new WindowsLiveStrategy({\r\n            clientID: config.clientID,\r\n            clientSecret: config.clientSecret,\r\n            callbackURL: config.callbackURL\r\n        },\r\n            function (accessToken, refreshToken, profile, done)\r\n            {\r\n                var db: db.DbClient = di.resolve('$db');\r\n                db.hget('users:externalLogin:' + profile.id, 'login', function (err, user)\r\n                {\r\n                    if (err)\r\n                    {\r\n                        db.quit();\r\n                        done(err);\r\n                    }\r\n                    else\r\n                    {\r\n                        if (!user)\r\n                        {\r\n                            db\r\n                                .multi()\r\n                                .sadd('users:externalLogins', 'users:externalLogin:' + profile.id)\r\n                                .hmset('users:externalLogin:' + profile.id, { name: profile.displayName, provider: profile.provider })\r\n                                .exec(function (err)\r\n                                {\r\n                                    db.quit();\r\n                                    done(err);\r\n                                });\r\n                        }\r\n                        else\r\n                        {\r\n                            db.quit();\r\n                            done(null, user);\r\n                        }\r\n                    }\r\n                });\r\n            }));\r\n    }\r\n\r\n    passport.use(new MacStrategy(function (mac, done)\r\n    {\r\n        if (mac && mac.mac)\r\n        {\r\n\r\n            var db = di.resolve('$db');\r\n\r\n            db.hget('users:externalLogin:' + mac.mac, 'login', function (err, userId)\r\n            {\r\n\r\n                if (!userId)\r\n                {\r\n                    db\r\n                        .multi()\r\n                        .sadd('users:externalLogins', 'users:externalLogin:' + mac.mac)\r\n                        .hmset('users:externalLogin:' + mac.mac, { provider: 'mac', name: mac.name })\r\n                        .exec(function (err)\r\n                        {\r\n                            db.quit();\r\n                            done(err);\r\n                        });\r\n                    debug('unauthorized', mac);\r\n                }\r\n                else\r\n                    db.quit();\r\n                if (err)\r\n                    done(err);\r\n                else\r\n                    done(null, userId);\r\n            });\r\n        }\r\n        else\r\n        {\r\n            done(null, { name: 'localhost' });\r\n        }\r\n    }));\r\n    app.use(passport.initialize());\r\n    app.use(passport.session());\r\n\r\n    app.use(function (req: express.Request, res: express.Response, next: express.NextFunction)\r\n    {\r\n        console.log(req.socket.remoteAddress);\r\n        if (req.socket.remoteAddress.substr(0, '192.168.'.length) != '192.168.' && req.socket.remoteAddress != '127.0.0.1' && req.socket.remoteAddress != '::1')\r\n        {\r\n            if (req.url != '/api/users/login' && !req['isAuthenticated']())\r\n            {\r\n                debug('windowslive');\r\n                var handler = passport.authenticate('windowslive', { scope: ['wl.signin', 'wl.basic'] });\r\n                handler(req, res, next);\r\n            }\r\n            else\r\n                next();\r\n        }\r\n        else\r\n        {\r\n            if (req.url != '/api/users/login' && !req['isAuthenticated']())\r\n            {\r\n                debug('mac');\r\n                var handler = passport.authenticate('mac');\r\n                handler(req, res, next);\r\n            }\r\n            else\r\n                next();\r\n        }\r\n    });\r\n})();"],"sourceRoot":"users/src/server"}